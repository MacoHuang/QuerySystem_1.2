<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.0.3/r-3.0.1/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" />
    <style>
        body{
            margin: 0;
            padding: 0;
            /* width: 100vw; */
            height: 100vh;
            margin-bottom: 8px;
        }
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,.1);
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        #searchObjectTable_wrapper .dt-length, #searchObjectTable_wrapper .dt-info, #searchObjectTable_wrapper .dt-paging {
            padding: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Main Search Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fa fa-search"></i> 物件查詢</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-4 col-md-6">
                        <label for="objectName" class="form-label">案名 / 區域 / 地址</label>
                        <input type="text" class="form-control" id="objectName" placeholder="關鍵字 (空格可複選)">
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="objectType" class="form-label">物件類型</label>
                        <select class="form-select" id="objectType">
                            <option value="">全部類型</option>
                            <option value="Building">建物</option>
                            <option value="Land">土地</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">總價(萬) / 租金(元)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="valuationFrom" placeholder="最低">
                            <span class="input-group-text">~</span>
                            <input type="number" class="form-control" id="valuationTo" placeholder="最高">
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label">地坪</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="landSizeFrom" placeholder="最小">
                            <span class="input-group-text">~</span>
                            <input type="number" class="form-control" id="landSizeTo" placeholder="最大">
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="contractType" class="form-label">合約類型</label>
                        <select class="form-select" id="contractType">
                            <option value="">全部</option>
                            <option value="口頭約">口頭約</option>
                            <option value="一般約">一般約</option>
                            <option value="專任約">專任約</option>
                            <option value="同行轉拋">同行轉拋</option>
                            <option value="租賃">租賃</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="contactPeron" class="form-label">開發業務</label>
                        <input type="text" class="form-control" id="contactPeron" placeholder="輸入姓名">
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Search Card -->
        <div class="card">
            <div class="card-header bg-secondary text-white" id="advanced-search-header" data-bs-toggle="collapse" data-bs-target="#advanced-search-body" aria-expanded="false" aria-controls="advanced-search-body" style="cursor: pointer;">
                <h5 class="mb-0"><i class="fa fa-sliders"></i> 進階條件 <i class="fa fa-chevron-down float-end"></i></h5>
            </div>
            <div id="advanced-search-body" class="collapse">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-2 col-md-6">
                            <label for="roadNearby" class="form-label">臨路米數</label>
                            <select class="form-select" id="roadNearby">
                                <option value="">不限</option>
                                <option value="0|4.9">~ 5米</option>
                                <option value="5|7.9">5 ~ 8米</option>
                                <option value="8|999">8米以上</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="objectWidth" class="form-label">面寬</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="objectWidthFrom" placeholder="最小">
                                <span class="input-group-text">~</span>
                                <input type="number" class="form-control" id="objectWidthTo" placeholder="最大">
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label">房數</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="roomFrom" placeholder="最少">
                                <span class="input-group-text">~</span>
                                <input type="number" class="form-control" id="roomTo" placeholder="最多">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <label for="isHasParkingSpace" class="form-label">停車位</label>
                            <select class="form-select" id="isHasParkingSpace">
                                <option value="">不限</option>
                                <option value="0">無</option>
                                <option value="1">有</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <label class="form-label">建物完成年</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="buildingAgeFrom" placeholder="最早">
                                <span class="input-group-text">~</span>
                                <input type="text" class="form-control" id="buildingAgeTo" placeholder="最晚">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <label for="direction" class="form-label">座向</label>
                            <select class="form-select" id="direction">
                                <option value="">不限</option>
                                <option value="座東朝西">座東朝西</option>
                                <option value="座西朝東">座西朝東</option>
                                <option value="座南朝北">座南朝北</option>
                                <option value="座北朝南">座北朝南</option>
                                <option value="座東北朝西南">座東北朝西南</option>
                                <option value="座東南朝西北">座東南朝西北</option>
                                <option value="座西北朝東南">座西北朝東南</option>
                                <option value="座西南朝東北">座西南朝東北</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-lg-2 offset-lg-4 col-md-3 offset-md-3 col-6">
                <div class="d-grid">
                    <button class="btn btn-danger  btn" id="clearBtn">清除</button>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 col-6">
                <div class="d-grid">
                    <button class="btn btn-primary btn" id="searchBtn">搜尋</button>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <table id="searchObjectTable" class="table table-bordered responsive display nowrap" style="width:100%"></table>

            </div>
        </div>
    </div>
    <div class="modal" tabindex="-1" id="showObjectInfoModal">
        <div class="modal-dialog">
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-2.0.3/r-3.0.1/datatables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
<script>
    var data = [];
    var dataTable;
    var toggleExpansionStatus = false;
    $(document).ready(function() {
        feather.replace();
        $("#searchObjectTable").on("preInit.dt", function () {
            $toggleExpanBtn = $("<button type='button' class='btn btn-sm btn-primary'>全部展開/摺疊</button>");
            $("#searchObjectTable_wrapper .dt-length label").append("&emsp;").append($toggleExpanBtn);
            $toggleExpanBtn.click(function(){
                toggleTableExpansion(!toggleExpansionStatus);
            });
        });
        dataTable = new DataTable('#searchObjectTable', {
            pageLength: 25,
            pagingType: "full_numbers",
            processing: true,
            reponsive: true,
            data: data,
            columns: [
                { 
                    title: "案名",
                    name: "objectName",
                    data: "objectName",
                    responsivePriority: 1,
                    render: function(data, type, row) {
                        var pictureLinkBtn = '';
                        if(row.pictureLink != '' && row.pictureLink != null){
                            pictureLinkBtn = '<a style="color:black" class="m-2" href="' + row.pictureLink + '" target="_blank"><i class="fa fa-picture-o"></i></a>';
                        }
                        var objectNumberPrefix = row.objectNumber ? row.objectNumber + ' ' : '';
                        return objectNumberPrefix + data + pictureLinkBtn;
                    }

                },
                { 
                    title: "總價",
                    name: "valuation",
                    data: "valuation",
                    responsivePriority: 2,
                    render: function(data, type, row) {
                        return data;
                    }
                },
                { 
                    title: "地坪",
                    name: "landSize",
                    data: "landSize",
                    responsivePriority: 2,
                    render: function(data, type, row) {
                        return data;
                    }
                },
                { 
                    title: "建坪",
                    name: "buildingSize",
                    data: "buildingSize",
                    responsivePriority: 3,
                    render: function(data, type, row) {
                        return data;
                    }
                },
                { 
                    title: "格局",
                    name: "housePattern",
                    data: "housePattern",
                    responsivePriority: 3,
                    render: function(data, type, row) {
                        return data;
                    }
                },
                { 
                    title: "地址",
                    name: "address",
                    data: "address",
                    responsivePriority: 3,
                    render: function(data, type, row) {
                        if(row.position == null || row.position == '') {
                            return row.location + row.address;
                        } else {
                            var positionType = 0;
                            var positionValue = row.position.split(' ')[0]
                            if(row.position.indexOf(',') > -1) {
                                positionType = 0;
                            } else {
                                positionType = 1;
                            }
                            if(positionType == 0) {
                                return '<a href="https://maps.google.com/?q=' + encodeURIComponent(positionValue) + '" target="_blank">' + row.location + row.address + '</a>';
                            } else {
                                if(positionValue.length == 8) {
                                    positionValue = '7QJ2' + positionValue;
                                }
                                return '<a href="https://www.google.com.tw/maps/place/' + encodeURIComponent(positionValue) + '" target="_blank">' + row.location + row.address + '</a>';
                            
                            }
                        }
                    }
                },
                { 
                    title: "",
                    name: "sequenceNumberInSheet",
                    data: "sequenceNumberInSheet",
                    responsivePriority: 1,
                    render: function(data, type, row) {
                        var html = "";
                        var infoBtn = $("<button>").addClass("btn btn-sm btn-info text-white").text(" 詳細 ").append($("<i>").addClass("fa fa-pencil")).attr("onclick", "showObjectInfo('" + row.objectType + "', '" + row.objectNumber + "')");
                        var chooseA4Btn = $("<button>").addClass("btn btn-sm btn-dark text-white").text(" 文件 ").append($("<i>").addClass("fa fa-file-text-o")).attr("onclick", "showDocInfo('" + row.objectType + "', '" + row.objectNumber + "')");

                        var btn_list = {};
                        btn_list[0] = infoBtn;
                        btn_list[1] = chooseA4Btn; 
                        for (var x in btn_list) {
                            html += $('<span>').addClass('m-2').append(btn_list[x]).prop('outerHTML');
                        }
                        return html;
                    }
                }
            ]
        });

        $("#objectType").on('change', function() {
            var objectType = $(this).val();
            if(objectType == 'Building') {
                $(".objectPattern-building").prop('checked', true);
                $(".objectPattern-land").prop('checked', false);
            } else if(objectType == 'Land') {
                $(".objectPattern-building").prop('checked', false);
                $(".objectPattern-land").prop('checked', true);
            } else if(objectType == '') {
                $(".objectPattern").prop('checked', true);
            }
        });
        
        $("#clearBtn").click(function() {
            clearSearch();
        });

        $('#searchBtn').click(function() {
            var contractType = $('#contractType').val();
            var objectType = $('#objectType').val();
            var objectName = $('#objectName').val();
            var valuationFrom = $('#valuationFrom').val();
            var valuationTo = $('#valuationTo').val();
            var landSizeFrom = $('#landSizeFrom').val();
            var landSizeTo = $('#landSizeTo').val();
            var objectPattern = $(".objectPattern").map(function() {
                if($(this).is(':checked')) {
                    return $(this).val();
                }
            }).get();
            var roadNearby = $('#roadNearby').val();
            var roomFrom = $('#roomFrom').val();
            var roomTo = $('#roomTo').val();
            var isHasParkingSpace = $('#isHasParkingSpace').val();
            var buildingAgeFrom = $('#buildingAgeFrom').val();
            var buildingAgeTo = $('#buildingAgeTo').val();
            var direction = $('#direction').val();
            var objectWidthFrom = $('#objectWidthFrom').val();
            var objectWidthTo = $('#objectWidthTo').val();
            var contactPeron = $('#contactPeron').val();

            $.blockUI({
                message: "<h1>查詢中...</h1>",
                css: {
                    border: 'none',
                    padding: '15px',
                    backgroundColor: '#000',
                    '-webkit-border-radius': '10px',
                    '-moz-border-radius': '10px',
                    opacity: .5,
                    color: '#fff'
                }
            });

            google.script.run.withSuccessHandler(onDataFetchSuccess).withFailureHandler(onDataFetchFailure).searchObjects(
                contractType,
                objectType,
                objectPattern, 
                objectName, 
                valuationFrom,
                valuationTo,
                landSizeFrom,
                landSizeTo,
                roadNearby,
                roomFrom,
                roomTo,
                isHasParkingSpace,
                buildingAgeFrom,
                buildingAgeTo,
                direction,
                objectWidthFrom,
                objectWidthTo,
                contactPeron);
        });
    });
    
    var onDataFetchSuccess = function(result) {
        console.log(result);
        dataTable.clear();
        dataTable.rows.add(JSON.parse(result));
        dataTable.draw();
        $(window).trigger('resize');
        $.unblockUI();
    }
    var onDataFetchFailure = function(result) {
        console.log(result);
        $.unblockUI();
    }

    function showObjectInfo(objectType, sequenceNumberInSheet) {
        $("#showObjectInfoModal .modal-dialog").addClass("modal-xl");
        $("#showObjectInfoModal").modal('show');
        $('#showObjectInfoModal').on('hidden.bs.modal', function (e) {
            $("#showObjectInfoModal .modal-dialog").html('');
            $("#showObjectInfoModal .modal-dialog").removeClass("modal-xl");
        });

        google.script.run.withSuccessHandler(onShowInfoSuccess).withFailureHandler(onShowInfoFailure).showObjectInfo(objectType, sequenceNumberInSheet);
    }

    var onShowInfoSuccess = function(result) {
        $("#showObjectInfoModal .modal-dialog").html(result);
        //console.log(result);
    }
    var onShowInfoFailure = function(result) {
        console.log(result);
    }

    function showDocInfo(objectType, sequenceNumberInSheet) {
        google.script.run.withSuccessHandler(onShowDocSuccess).withFailureHandler(onShowDocFailure).showObjectA4Info(objectType, sequenceNumberInSheet);
        $.blockUI({
            message: "<h1>產生文件中...</h1>",
            css: {
                border: 'none',
                padding: '15px',
                backgroundColor: '#000',
                '-webkit-border-radius': '10px',
                '-moz-border-radius': '10px',
                opacity: .5,
                color: '#fff'
            }
        });
    }

    var onShowDocSuccess = function(result) {
        //console.log('onShowDocSuccess:' + result);
        window.open(result, '_blank');
        $.unblockUI();
    }
    var onShowDocFailure = function(result) {
        //console.log('onShowDocFailure:' + result);
        $.unblockUI();
    }


    function clearSearch() {
        $('#contractType').val('');
        $('#objectType').val('');
        $('#objectName').val('');
        $('#valuationFrom').val('');
        $('#valuationTo').val('');
        $('#landSizeFrom').val('');
        $('#landSizeTo').val('');
        $(".objectPattern").prop('checked', false);
        $('#roadNearby').val('');
        $('#roomFrom').val('');
        $('#roomTo').val('');
        $('#isHasParkingSpace').val('');
        $('#buildingAgeFrom').val('');
        $('#buildingAgeTo').val('');
        $('#direction').val('');
        $('#objectWidthFrom').val('');
        $('#objectWidthTo').val('');
        $('#contactPeron').val('');
    }

    function toggleTableExpansion(isShown){
        console.log(isShown);
        if(isShown) {
            console.log(1);
            dataTable.rows(':not(.dtr-expanded)').nodes().to$().find('td:first-child').trigger('click');
        } else {
            console.log(2);
            dataTable.rows('.dtr-expanded').nodes().to$().find('td:first-child').trigger('click');
        }
        toggleExpansionStatus = isShown;
    }
</script>
</html>